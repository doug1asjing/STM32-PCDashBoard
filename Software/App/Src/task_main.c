/*
 * task_main.c
 *
 *  Created on: Feb 6, 2025
 *      Author: dougl
 */
#include "stm32f1xx_hal.h"
#include "oled.h"
#include "usart.h"
#include "kk_rtc.h"
#include "stm32f1xx_hal_dma.h"
#include "btn.h"
#include <task_main.h>
#include "tim.h"
#include "speaker.h"
#include "dht11.h"

#define PAGES 4 //页面数量
#define TOMATO_WORK_MINUTE 25 //番茄钟工作时长
#define TOMATO_REST_MINUTE 5  //番茄钟休息时长


uint8_t recvInfo[7] = {0, 0, 0, 0, 0, 0, 0, 0};
volatile uint32_t displayMode = 0; //Bug:使用uint8_t 该数值会乱变，需要修改为uint32_t
volatile uint32_t controlMode = 0;

//番茄钟beep提示
volatile uint8_t beepFlag = 0;

uint32_t tomatoClockTimes = 0;
char controlMode_Str[4];
char displayMode_Str[4];
char yearDate[30];
char hourMinute[30];
char tomatoMinuteSecends[6];
char conditionTemp_str[6];
char conditionHumid_str[6];
char cpuUsage_str[4];
char memUsage_str[4];
char tomatoClockTimes_Str[4];
char autoRollTime_Str[4];

uint32_t tomatoMinute = TOMATO_WORK_MINUTE;
uint32_t Seconds = 0;

uint16_t temperature;
uint16_t humidity;

uint32_t autoRollTime = 0;



#define RTC_INIT_FLAG 0x2222

void task_main_init()
{
	HAL_Delay(20);
	OLED_DisPlay_On();
	OLED_Init();
	HAL_UART_Receive_IT(&huart1, &recvInfo, 8);
	Btn_SetMainPressedCallback(onMainBtnPressed);
	Btn_SetSecondPressedCallback(onSecondBtnPressed);
	DHT11_Init();
}

void task_main()
{


	if(displayMode == 0)
	{
		UI_Draw_Main();
		RTC_GetTime();




	}
	else if(displayMode == 1)
	{
		UI_Draw_Tomato_Clock();
		TomatoClock_Beep();

	}

	else if(displayMode == 2)
	{

		UI_Draw_Temp();


	}
	else if(displayMode == 3)
	{

		UI_Draw_Settings();


	}



	Main_Btn_Loop();
	Second_Btn_Loop();
	GET_Condition();


}

void Condition_Send()
{
	uint8_t condition[1];
	condition[0] = temperature;
	condition[1] = humidity;

	HAL_UART_Transmit(&huart1, condition, 2, HAL_MAX_DELAY);
	//HAL_Delay(50);
}

void UI_Draw_Main()
{

	OLED_NewFrame();
	//显示当前页
	//UI_Page();
	OLED_PrintASCIIString(24, 0, yearDate, &afont16x8, OLED_COLOR_NORMAL);
	OLED_PrintASCIIString(32, 16, hourMinute, &afont16x8, OLED_COLOR_NORMAL);
	OLED_PrintString(1, 32, "CPU:", &font16x16, OLED_COLOR_NORMAL);
	OLED_PrintString(1, 48, "RAM:", &font16x16, OLED_COLOR_NORMAL);
	//负载条框线绘制
	OLED_DrawRectangle(32, 34, 70, 12, OLED_COLOR_NORMAL);
	OLED_DrawRectangle(32, 50, 70, 12, OLED_COLOR_NORMAL);
	//负载条绘制
	OLED_DrawFilledRectangle(32, 34, recvInfo[0] * 70 * 0.01, 12, OLED_COLOR_NORMAL);
	OLED_DrawFilledRectangle(32, 50, recvInfo[1] * 70 * 0.01, 12, OLED_COLOR_NORMAL);

	//使用率显示
	sprintf(cpuUsage_str, "%02d", recvInfo[0]);
	sprintf(memUsage_str, "%02d", recvInfo[1]);
	OLED_PrintASCIIChar(120, 32, '%', &afont16x8, OLED_COLOR_NORMAL);
	OLED_PrintASCIIChar(120, 48, '%', &afont16x8, OLED_COLOR_NORMAL);
	OLED_PrintASCIIString(104, 32, cpuUsage_str, &afont16x8, OLED_COLOR_NORMAL);
	OLED_PrintASCIIString(104, 48, memUsage_str, &afont16x8, OLED_COLOR_NORMAL);

	OLED_ShowFrame();
	HAL_Delay(100);


}

void UI_Draw_Temp()
{
	const uint8_t zh15x15[][34] = {
	/* 0 当 */ {0xe5,0xbd,0x93,0x00,0x00,0x20,0x22,0x24,0x28,0x20,0x3f,0x20,0x30,0x28,0x26,0xe0,0x00,0x00,0x00,0x00,0x10,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x1f,0x00,0x00,0x00,},
	/* 1 前 */ {0xe5,0x89,0x8d,0x00,0x04,0x04,0xf4,0x95,0x96,0x94,0xf4,0x04,0xe6,0x05,0x04,0xf4,0x04,0x04,0x00,0x00,0x00,0x3f,0x04,0x04,0x24,0x3f,0x00,0x07,0x10,0x20,0x1f,0x00,0x00,0x00,},
	/* 2 环 */ {0xe7,0x8e,0xaf,0x00,0x42,0x42,0xfe,0x42,0x42,0x00,0x02,0x02,0xc2,0x32,0xee,0x42,0x82,0x02,0x00,0x08,0x08,0x07,0x04,0x00,0x04,0x02,0x01,0x00,0x00,0x3f,0x00,0x00,0x03,0x00,},
	/* 3 境 */ {0xe5,0xa2,0x83,0x00,0x08,0x08,0xff,0x08,0x08,0x12,0xd2,0x56,0x5a,0x53,0x5a,0x56,0xd2,0x12,0x00,0x04,0x04,0x03,0x02,0x22,0x20,0x27,0x15,0x0d,0x05,0x3d,0x25,0x27,0x30,0x00,},
	/* 4 信 */ {0xe4,0xbf,0xa1,0x00,0x40,0x20,0xf8,0x07,0x00,0x08,0xa8,0xa8,0xa9,0xae,0xa8,0xa8,0xa8,0x08,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x3e,0x12,0x12,0x12,0x12,0x12,0x3e,0x00,0x00,},
	/* 5 息 */ {0xe6,0x81,0xaf,0x00,0x00,0x00,0x00,0xfc,0x54,0x56,0x55,0x54,0x54,0x54,0xfc,0x00,0x00,0x00,0x00,0x10,0x08,0x04,0x01,0x1d,0x21,0x23,0x2d,0x21,0x21,0x39,0x02,0x04,0x18,0x00,},
	/* 6 温 */ {0xe6,0xb8,0xa9,0x00,0x10,0x21,0xc6,0x30,0x00,0x00,0x7e,0x2a,0x2a,0x2a,0x2a,0x7e,0x00,0x00,0x00,0x02,0x3e,0x01,0x00,0x20,0x3f,0x21,0x3f,0x21,0x21,0x3f,0x21,0x3f,0x20,0x00,},
	/* 7 度 */ {0xe5,0xba,0xa6,0x00,0x00,0x00,0xfc,0x14,0x14,0x14,0x7c,0x55,0x56,0x54,0x7c,0x14,0x14,0x14,0x00,0x20,0x18,0x07,0x00,0x21,0x21,0x13,0x15,0x09,0x15,0x13,0x21,0x20,0x00,0x00,},
	/* 8 湿 */ {0xe6,0xb9,0xbf,0x00,0x10,0x21,0xc6,0x30,0x00,0x00,0x3e,0x2a,0xaa,0x2a,0xaa,0x2a,0x3e,0x00,0x00,0x02,0x3e,0x01,0x00,0x20,0x21,0x26,0x20,0x3f,0x20,0x3f,0x24,0x23,0x20,0x00,},
	/* 9 度 */ {0xe5,0xba,0xa6,0x00,0x00,0x00,0xfc,0x14,0x14,0x14,0x7c,0x55,0x56,0x54,0x7c,0x14,0x14,0x14,0x00,0x20,0x18,0x07,0x00,0x21,0x21,0x13,0x15,0x09,0x15,0x13,0x21,0x20,0x00,0x00,}
	};
	const Font tempFont15x15 = {.w =15, .h = 15, .chars = (const uint8_t *)zh15x15,.len = sizeof(zh15x15)/34, .ascii = &afont16x8};




	OLED_NewFrame();
	//显示当前页

	UI_Page();
	OLED_PrintString(24, 0, "当前环境信息", &tempFont15x15, OLED_COLOR_NORMAL);
	OLED_DrawLine(0, 16, 128, 16, OLED_COLOR_NORMAL);
	sprintf(conditionTemp_str, "%02d", temperature);
	sprintf(conditionHumid_str, "%02d", humidity);

	OLED_PrintString(1, 28, "温度", &tempFont15x15, OLED_COLOR_NORMAL);
	OLED_PrintString(1, 44, "湿度", &tempFont15x15, OLED_COLOR_NORMAL);
	//负载条框线绘制
	OLED_DrawRectangle(32, 30, 70, 12, OLED_COLOR_NORMAL);
	OLED_DrawRectangle(32, 46, 70, 12, OLED_COLOR_NORMAL);
	//负载条绘制
	OLED_DrawFilledRectangle(32, 30, temperature * 70 * 0.01 * 2, 12, OLED_COLOR_NORMAL); //量程0-50度
	OLED_DrawFilledRectangle(32, 46, humidity * 70 * 0.01, 12, OLED_COLOR_NORMAL); //量程0-100%
	//数值显示
	OLED_PrintASCIIString(104, 28, conditionTemp_str, &afont16x8, OLED_COLOR_NORMAL);
	OLED_PrintASCIIString(104, 44, conditionHumid_str, &afont16x8, OLED_COLOR_NORMAL);


	OLED_PrintASCIIChar(120, 28, 'C', &afont16x8, OLED_COLOR_NORMAL);
	OLED_DrawCircle(119, 28, 1, OLED_COLOR_NORMAL);
	OLED_PrintASCIIChar(120, 44, '%', &afont16x8, OLED_COLOR_NORMAL);

	OLED_ShowFrame();
	HAL_Delay(100);


}

void UI_Draw_Tomato_Clock()
{
	const uint8_t zh15x15[][34] = {
	/* 0 番 */ {0xe7,0x95,0xaa,0x00,0x10,0x12,0x96,0x5a,0x32,0x12,0xfe,0x32,0x12,0x59,0x95,0x10,0x10,0x00,0x00,0x01,0x01,0x3f,0x15,0x15,0x15,0x1f,0x15,0x15,0x15,0x3f,0x01,0x01,0x00,0x00,},
	/* 1 茄 */ {0xe8,0x8c,0x84,0x00,0x00,0x44,0x44,0xf4,0x44,0x5f,0xc4,0x04,0x04,0xdf,0x44,0x44,0xc4,0x04,0x00,0x20,0x10,0x08,0x07,0x10,0x20,0x1f,0x00,0x00,0x3f,0x10,0x10,0x3f,0x00,0x00,},
	/* 2 钟 */ {0xe9,0x92,0x9f,0x00,0x08,0x27,0xe4,0x24,0x24,0x04,0xf8,0x08,0x08,0xff,0x08,0x08,0xf8,0x00,0x00,0x01,0x01,0x3f,0x11,0x09,0x01,0x03,0x01,0x01,0x3f,0x01,0x01,0x03,0x00,0x00,},
	/* 0 完 */ {0xe5,0xae,0x8c,0x00,0x90,0x8c,0x84,0x94,0x94,0x95,0x96,0x94,0x94,0x94,0x84,0x8c,0x84,0x00,0x00,0x20,0x20,0x10,0x0c,0x03,0x00,0x00,0x1f,0x20,0x20,0x20,0x20,0x38,0x00,0x00,},
	/* 1 成 */ {0xe6,0x88,0x90,0x00,0x00,0x00,0xf8,0x48,0x48,0xc8,0x08,0x7f,0x88,0x08,0x89,0x6a,0x08,0x08,0x00,0x20,0x18,0x07,0x04,0x08,0x07,0x20,0x10,0x09,0x06,0x09,0x10,0x20,0x38,0x00,}
	};
	const Font tomatoFont15x15 = {.w =15, .h = 15, .chars = (const uint8_t *)zh15x15,.len = sizeof(zh15x15)/34, .ascii = &afont16x8};

	OLED_NewFrame();
	//显示当前页
	UI_Page();
	OLED_PrintString(45, 0, "番茄钟", &tomatoFont15x15, OLED_COLOR_NORMAL);
	OLED_DrawLine(0, 16, 128, 16, OLED_COLOR_NORMAL);
	sprintf(tomatoMinuteSecends, "%02d:%02d", tomatoMinute, Seconds);
	OLED_PrintASCIIString(48, 24, tomatoMinuteSecends, &afont16x8, OLED_COLOR_NORMAL);
	OLED_PrintString(20, 48, "完成番茄钟:", &tomatoFont15x15, OLED_COLOR_NORMAL);
	sprintf(tomatoClockTimes_Str, "%d", tomatoClockTimes);
	OLED_PrintASCIIString(104, 48, tomatoClockTimes_Str, &afont16x8, OLED_COLOR_NORMAL);
	OLED_ShowFrame();
	HAL_Delay(100);


}

void UI_Draw_Settings()
{
	const uint8_t menuZh15x15[][34] = {
	/* 0 设 */ {0xe8,0xae,0xbe,0x00,0x20,0x21,0x22,0xe6,0x00,0x20,0x50,0xcf,0x41,0x41,0x41,0x5f,0xd0,0x10,0x00,0x00,0x00,0x00,0x1f,0x08,0x24,0x20,0x11,0x16,0x08,0x14,0x13,0x20,0x20,0x00,},
	/* 1 置 */ {0xe7,0xbd,0xae,0x00,0x20,0x20,0x2f,0xa9,0xa9,0xaf,0xf9,0xa9,0xaf,0xa9,0xa9,0x2f,0x20,0x20,0x00,0x20,0x20,0x20,0x3f,0x2a,0x2a,0x2a,0x2a,0x2a,0x2a,0x3f,0x20,0x20,0x20,0x00,}
	};
	const Font settingFont15x15 = {.w =15, .h = 15, .chars = (const uint8_t *)menuZh15x15,.len = sizeof(menuZh15x15)/34, .ascii = &afont16x8};

	const uint8_t rollZh15x15[][34] = {
	/* 0 自 */ {0xe8,0x87,0xaa,0x00,0x00,0x00,0x00,0xf8,0x48,0x4c,0x4b,0x48,0x48,0x48,0x48,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x12,0x12,0x12,0x12,0x12,0x12,0x12,0x3f,0x00,0x00,0x00,},
	/* 1 动 */ {0xe5,0x8a,0xa8,0x00,0x20,0x24,0xe4,0x24,0x24,0x24,0x00,0x10,0x10,0xff,0x10,0x10,0x10,0xf0,0x00,0x04,0x0e,0x05,0x04,0x05,0x2e,0x10,0x08,0x06,0x01,0x10,0x20,0x10,0x0f,0x00,},
	/* 2 滚 */ {0xe6,0xbb,0x9a,0x00,0x10,0x21,0xc6,0x30,0x00,0x24,0x54,0x6c,0xd5,0x46,0x44,0x6c,0x94,0x24,0x00,0x02,0x3e,0x01,0x00,0x08,0x04,0x02,0x3f,0x10,0x03,0x04,0x0c,0x12,0x20,0x00,},
	/* 3 动 */ {0xe5,0x8a,0xa8,0x00,0x20,0x24,0xe4,0x24,0x24,0x24,0x00,0x10,0x10,0xff,0x10,0x10,0x10,0xf0,0x00,0x04,0x0e,0x05,0x04,0x05,0x2e,0x10,0x08,0x06,0x01,0x10,0x20,0x10,0x0f,0x00,},
	/* 4 超 */ {0xe8,0xb6,0x85,0x00,0x20,0xa4,0x24,0xff,0x24,0x24,0x24,0x40,0xb2,0x8e,0x82,0xa2,0xbe,0x00,0x00,0x38,0x07,0x08,0x1f,0x11,0x21,0x20,0x20,0x2f,0x24,0x24,0x24,0x2f,0x20,0x00,},
	/* 5 时 */ {0xe6,0x97,0xb6,0x00,0x00,0xfc,0x44,0x44,0xfc,0x10,0x10,0x50,0x90,0x10,0x10,0xff,0x10,0x10,0x00,0x00,0x0f,0x04,0x04,0x0f,0x00,0x00,0x00,0x01,0x10,0x20,0x1f,0x00,0x00,0x00,},
	/* 6 关 */ {0xe5,0x85,0xb3,0x00,0x80,0x90,0x90,0x91,0x96,0x90,0xf0,0x90,0x94,0x93,0x90,0x90,0x80,0x00,0x00,0x20,0x20,0x10,0x08,0x04,0x02,0x01,0x02,0x04,0x08,0x10,0x20,0x20,0x00,0x00,},
	/* 7 闭 */ {0xe9,0x97,0xad,0x00,0x00,0xf8,0x01,0x22,0x26,0x20,0x22,0xa2,0xfa,0x22,0x22,0x02,0xfe,0x00,0x00,0x00,0x3f,0x00,0x00,0x04,0x02,0x09,0x08,0x0f,0x00,0x10,0x20,0x1f,0x00,0x00,},
	/* 8 秒 */ {0xe7,0xa7,0x92,0x00,0x10,0x12,0xd2,0xfe,0x91,0x11,0xc0,0x38,0x00,0xff,0x00,0x08,0x10,0x60,0x00,0x04,0x03,0x00,0x3f,0x00,0x21,0x20,0x10,0x10,0x09,0x04,0x02,0x01,0x00,0x00,}
	};
	const Font rollFont15x15 = {.w =15, .h = 15, .chars = (const uint8_t *)rollZh15x15,.len = sizeof(rollZh15x15)/34, .ascii = &afont16x8};


	OLED_NewFrame();
	//显示当前页
	UI_Page();
	UI_Page();
	OLED_PrintString(50, 0, "设置", &settingFont15x15, OLED_COLOR_NORMAL);
	OLED_DrawLine(0, 16, 128, 16, OLED_COLOR_NORMAL);
	OLED_PrintString(0, 32, "自动滚动超时:", &rollFont15x15, OLED_COLOR_NORMAL);
	if(autoRollTime == 0)
	{
		OLED_PrintString(50, 48, "关闭", &rollFont15x15, OLED_COLOR_NORMAL);

	}
	else
	{
		sprintf(autoRollTime_Str, "%d", autoRollTime);
		OLED_PrintASCIIString(56, 48, autoRollTime_Str, &afont16x8, OLED_COLOR_NORMAL);
		OLED_PrintString(72, 48, "秒", &rollFont15x15, OLED_COLOR_NORMAL);
	}

	OLED_ShowFrame();
	HAL_Delay(100);


}




void Tomato_Clock()
{
	//启动番茄钟计时器计时
	HAL_TIM_Base_Start_IT(&htim2);

}

void TomatoClock_Beep()
{
	if(beepFlag)
	{
		Speaker_Beep_Tomato_Clock();
	}
	beepFlag = 0;
}

void GET_Condition()
{
	DHT11_Read_Data(&temperature,&humidity);
	temperature = temperature>>8;
	humidity = humidity>>8;


}


void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim) //处理番茄钟逻辑
{
	static uint8_t tomatoClockRunningStatus = 0; //用于标记番茄钟运行状态：0，工作周期。1，休息周期
	if (htim->Instance == TIM2)  // 仅处理 TIM2 的中断
	{
		if(tomatoClockRunningStatus == 0)
		{
			if(Seconds == 0)
			{
				Seconds = 59;
				tomatoMinute --;
			}
			else
			{
				Seconds --;
			}


			if(Seconds == 0 && tomatoMinute == 0)
			{
				tomatoMinute = TOMATO_REST_MINUTE;
				tomatoClockRunningStatus = 1;
				beepFlag = 1;
			}

		}

		else if(tomatoClockRunningStatus == 1)
		{
			if(Seconds == 0)
			{
				Seconds = 59;
				tomatoMinute --;
			}
			else
			{
				Seconds --;
			}

			if(Seconds == 0 && tomatoMinute == 0)
			{
				tomatoMinute = TOMATO_WORK_MINUTE;
				tomatoClockRunningStatus = 0;
				beepFlag = 1;
				tomatoClockTimes ++;
				}

		}

	}
	//自动滚动页面逻辑
	if(htim->Instance == TIM4)
	{
		static uint8_t rollTime = 0;
		rollTime++;
		if(rollTime >= autoRollTime)
		{
			if(displayMode > 1)
			{
				displayMode = 0;
			}
			else
			{
				displayMode ++;
			}

			rollTime = 0;
		}
	}



}



void UI_Page()
{
	sprintf(displayMode_Str, "%d", displayMode);
	OLED_PrintASCIIString(1, 1, displayMode_Str, &afont16x8, OLED_COLOR_NORMAL);
}

void RTC_GetTime()
{
	struct tm* now = KK_RTC_GetTime();
	sprintf(yearDate, "%d-%02d-%02d", now->tm_year + 1900, now->tm_mon + 1, now->tm_mday);
	sprintf(hourMinute, "%02d:%02d:%02d", now->tm_hour, now->tm_min, now->tm_sec);

}

void RTC_SerialSetTime()
{
	uint32_t initFlag = HAL_RTCEx_BKUPRead(&hrtc, RTC_BKP_DR1);
	if(initFlag == RTC_INIT_FLAG) return;

	struct tm time_Serial = {
	          .tm_year = recvInfo[2],
	          .tm_mon = recvInfo[3] - 1,
	          .tm_mday = recvInfo[4],
	          .tm_hour = recvInfo[5],
	          .tm_min = recvInfo[6],
	          .tm_sec = recvInfo[7],
	};
	KK_RTC_SetTime(&time_Serial);
	HAL_RTCEx_BKUPWrite(&hrtc, RTC_BKP_DR1, RTC_INIT_FLAG);


}

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
	if (huart->Instance == USART1)
	{
		HAL_UART_IRQHandler(&huart1);

		__HAL_UART_CLEAR_IDLEFLAG(&huart1);
		HAL_UART_DMAStop(&huart1);
		HAL_UART_Receive_DMA(&huart1, (uint32_t)&recvInfo, 8);
		RTC_SerialSetTime();
		Condition_Send();
	}

}

void onMainBtnPressed()
{
	Speaker_Beep();
	displayMode++;
	if(displayMode > PAGES - 1)
	{
		displayMode = 0;
	}

}

void onSecondBtnPressed()
{
	static uint32_t tomatoClockStatus = 0; //记录番茄钟状态，0为未启用，1为启用
	Speaker_Beep();
	if(displayMode == 1)
	{
		if(tomatoClockStatus == 0)
		{
			Tomato_Clock();
			tomatoClockStatus = 1;
		}
		else if (tomatoClockStatus == 1)
		{
			HAL_TIM_Base_Stop(&htim2);
			tomatoClockStatus = 0;
		}


	}
	else if (displayMode == 3)
	{
		autoRollTime += 30;
		HAL_TIM_Base_Start_IT(&htim4);

		if(autoRollTime > 90)
		{
			autoRollTime = 0;
			HAL_TIM_Base_Stop(&htim4);
		}

	}

}


